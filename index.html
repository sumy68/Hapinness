<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéüÔ∏è Tickets kaufen</title>

  <!-- PayPal JS SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=AXhWhmESFDnMHbhG_Vktz5V4ko3lXnzMjoUDDYJy8VWHm5ktfQMEJ47cHUKLr4Z1eBnCPeWle48gNZLl&currency=EUR&components=buttons&intent=capture&disable-funding=card,bancontact,blik,eps,giropay,ideal,mybank,p24,sepa,sofort,venmo,credit"></script>

  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
           max-width: 520px; margin: 40px auto; padding: 0 20px; line-height: 1.5; }
    h1 { margin-bottom: 14px; }
    label { display:block; font-size:14px; margin-top:10px; }
    input { width:100%; padding:10px; margin-top:4px; border:1px solid #ccc; border-radius:8px; box-sizing:border-box; }
    #total { font-weight:700; margin-top:10px; }
    #paypal-button-container { margin-top:18px; }
    #msg { margin-top:14px; padding:12px; border-radius:8px; display:none; white-space:pre-line; }
    #msg.success { background:rgba(0,128,0,.1); color:#064; }
    #msg.error   { background:rgba(255,0,0,.1); color:#600; }
    #msg.info    { background:rgba(0,0,255,.08); color:#004; }
    .muted { color:#666; font-size:13px; }
  </style>
</head>
<body>
  <h1>üéüÔ∏è Tickets kaufen</h1>

  <form id="ticketForm">
    <label for="vorname">Vorname</label>
    <input type="text" id="vorname" />

    <label for="nachname">Nachname</label>
    <input type="text" id="nachname" />

    <label for="geburtsdatum">Geburtsdatum</label>
    <input type="date" id="geburtsdatum" />

    <label for="email">E-Mail f√ºr Ticketversand</label>
    <input type="email" id="email" inputmode="email" autocomplete="email" />

    <label for="qty">Anzahl Tickets</label>
    <input type="number" id="qty" min="1" max="20" value="1" />
  </form>

  <div id="total">Gesamt: 20,00 ‚Ç¨</div>
  <div id="paypal-button-container"></div>
  <div id="msg" role="status" aria-live="polite"></div>

  <p class="muted">
    Hinweis: Nur PayPal ist aktiviert. Die eingegebene E-Mail dient ausschlie√ülich dem Ticketversand und muss
    nicht mit der PayPal-E-Mail √ºbereinstimmen.
  </p>

  <script>
    const PRICE_EUR = 20.00;
    const MAX_QTY   = 20;
    const $ = id => document.getElementById(id);
    
    const clampQty = (v) => {
      let n = parseInt(v,10);
      if (Number.isNaN(n)) n = 1;
      return Math.max(1, Math.min(MAX_QTY, n));
    };
    const formatEUR = (num) => Number(num).toLocaleString("de-DE",{style:"currency",currency:"EUR"});
    
    function updateTotal(){
      const q = clampQty($("qty").value);
      $("qty").value = q;
      $("total").textContent = "Gesamt: " + formatEUR(q * PRICE_EUR);
    }
    $("qty").addEventListener("input", updateTotal);
    updateTotal();
    
    function showMsg(text, type="info"){
      const box = $("msg");
      box.className = type;
      box.textContent = text;
      box.style.display = "block";
    }
    
    paypal.Buttons({
      style: { layout:"vertical", color:"gold", shape:"rect", label:"paypal" },
    
      onClick: (data, actions) => {
        if (!($("email").value.trim())) {
          alert("Bitte eine g√ºltige E-Mail f√ºr den Ticketversand eingeben!");
          return actions.reject();
        }
        return actions.resolve();
      },
    
      // Bestellung √ºber den Server erstellen
      createOrder: () => {
        const qty = clampQty($("qty").value);
        return fetch("/create-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ quantity: qty })
        })
        .then(res => res.json())
        .then(data => data.id);
      },
    
      // Zahlung genehmigt -> Server capturen lassen UND Mail verschicken
      onApprove: (data) => {
        const payload = {
          orderID: data.orderID,
          vorname: $("vorname").value.trim(),
          nachname: $("nachname").value.trim(),
          alter: $("geburtsdatum").value.trim(),
          email: $("email").value.trim(),
          quantity: clampQty($("qty").value)
        };
    
        return fetch("/capture-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(result => {
          if (!result.ticketNumber) throw new Error("Keine Ticketnummer vom Server");
          showMsg(
            "‚úÖ Zahlung erfolgreich!\n\n" +
            "Ticketnummer: " + result.ticketNumber + "\n" +
            "Tickets: " + payload.quantity + " √ó " + formatEUR(PRICE_EUR) + "\n" +
            "Gesamt: " + formatEUR(payload.quantity * PRICE_EUR) + "\n" +
            "Best√§tigung an: " + payload.email,
            "success"
          );
        })
        .catch(err => {
          console.error(err);
          showMsg("‚ùå Fehler beim Abschluss / Mailversand: " + err.message, "error");
        });
      }
    
    }).render("#paypal-button-container");
    </script>   
</body>
</html>
