<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéüÔ∏è Tickets kaufen</title>

  <!-- PayPal JS SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=AXhWhmESFDnMHbhG_Vktz5V4ko3lXnzMjoUDDYJy8VWHm5ktfQMEJ47cHUKLr4Z1eBnCPeWle48gNZLl&currency=EUR&components=buttons&intent=capture&disable-funding=card,bancontact,blik,eps,giropay,ideal,mybank,p24,sepa,sofort,venmo,credit"></script>

  <style>
    :root { --ok:#064; --okbg:rgba(0,128,0,.08); --err:#600; --errbg:rgba(255,0,0,.08); --info:#024; --infobg:rgba(0,0,255,.06); }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; max-width: 560px; margin: 40px auto; padding: 0 16px; line-height: 1.5; }
    h1 { margin: 0 0 14px }
    label { display:block; font-size:14px; margin-top:10px }
    input { width:100%; padding:10px; margin-top:4px; border:1px solid #ccc; border-radius:8px; box-sizing:border-box }
    #total { font-weight:700; margin-top:12px }
    #paypal-button-container { margin-top:18px }
    #msg { margin-top:14px; padding:12px; border-radius:8px; display:none; white-space:pre-line }
    #msg.success { background:var(--okbg); color:var(--ok) }
    #msg.error   { background:var(--errbg); color:var(--err) }
    #msg.info    { background:var(--infobg); color:var(--info) }
    .muted { color:#666; font-size:13px; margin-top:12px }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px }
  </style>
</head>
<body>
  <h1>üéüÔ∏è Tickets kaufen</h1>

  <form id="ticketForm" onsubmit="return false;">
    <div class="row">
      <div>
        <label for="vorname">Vorname</label>
        <input type="text" id="vorname" autocomplete="given-name" required />
      </div>
      <div>
        <label for="nachname">Nachname</label>
        <input type="text" id="nachname" autocomplete="family-name" required />
      </div>
    </div>

    <label for="geburtsdatum">Geburtsdatum</label>
    <input type="date" id="geburtsdatum" required />

    <label for="email">E-Mail f√ºr Ticketversand</label>
    <input type="email" id="email" inputmode="email" autocomplete="email" required />

    <label for="qty">Anzahl Tickets</label>
    <input type="number" id="qty" min="1" max="20" value="1" required />
  </form>

  <div id="total">Gesamt: 20,00 ‚Ç¨</div>
  <div id="paypal-button-container"></div>
  <div id="msg" role="status" aria-live="polite"></div>

  <p class="muted">
    Hinweis: Als Bezahlart ist nur PayPal aktiv. Die hier eingegebene E-Mail wird ausschlie√ülich
    f√ºr den Ticketversand verwendet und muss nicht mit der PayPal-Adresse √ºbereinstimmen.
  </p>

  <script>
    // ------- API-Base (lokal oder deployed) -------
    // F√ºr LOKAL: leer lassen ("") ‚Üí nutzt http://localhost:3000
    // F√ºr LIVE: deine Backend-URL eintragen, z.B. "https://ticket-api.onrender.com"
    const API_BASE = "";

    // ------- Config & Helpers -------
    const PRICE_EUR = 20.00;
    const MAX_QTY   = 20;
    const $  = (id) => document.getElementById(id);
    const eur = (x) => Number(x).toLocaleString("de-DE",{ style:"currency", currency:"EUR" });
    const validEmail = (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((v||"").trim());
    const clampQty = (v) => {
      let n = parseInt(v,10);
      if (Number.isNaN(n)) n = 1;
      return Math.max(1, Math.min(MAX_QTY, n));
    };

    function showMsg(text, type="info") {
      const box = $("msg");
      box.className = type;
      box.textContent = text;
      box.style.display = "block";
    }

    function updateTotal(){
      const q = clampQty($("qty").value);
      $("qty").value = q;
      $("total").textContent = "Gesamt: " + eur(q * PRICE_EUR);
    }
    $("qty").addEventListener("input", updateTotal);
    updateTotal();

    function formValid() {
      const vorname = $("vorname").value.trim();
      const nachname = $("nachname").value.trim();
      const geburtsdatum = $("geburtsdatum").value.trim();
      const email = $("email").value.trim();
      const qty = clampQty($("qty").value);
      if (!vorname || !nachname) return false;
      if (!geburtsdatum) return false;
      if (!validEmail(email)) return false;
      if (!qty || qty < 1) return false;
      return true;
    }

    // ------- PayPal Buttons (Server Flow) -------
    paypal.Buttons({
      style: { layout:"vertical", color:"gold", shape:"rect", label:"paypal" },

      onClick: (data, actions) => {
        if (!formValid()) {
          alert("Bitte alle Felder korrekt ausf√ºllen (Vorname, Nachname, Geburtsdatum, E-Mail, Anzahl).");
          return actions.reject();
        }
        showMsg("‚è≥ Bestellung wird erstellt ...", "info");
        return actions.resolve();
      },

      // 1) Order auf deinem Server erstellen
      createOrder: () => {
        const quantity = clampQty($("qty").value);
        return fetch(`${API_BASE}/create-order`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ quantity })
        })
        .then(res => {
          if (!res.ok) throw new Error("create-order fehlgeschlagen");
          return res.json();
        })
        .then(data => data.id);
      },

      // 2) Nach Genehmigung: auf deinem Server capturen + Mail versenden
      onApprove: (data) => {
        const payload = {
          orderID:  data.orderID,
          vorname:  $("vorname").value.trim(),
          nachname: $("nachname").value.trim(),
          geburtsdatum: $("geburtsdatum").value.trim(),
          email:    $("email").value.trim(),
          quantity: clampQty($("qty").value)
        };

        return fetch(`${API_BASE}/capture-order`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(async (res) => {
          const result = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(result?.error || "capture-order fehlgeschlagen");
          if (!result.ticketNumber) throw new Error("Keine Ticketnummer erhalten.");

          showMsg(
            "‚úÖ Zahlung erfolgreich!\n\n" +
            "Ticketnummer: " + result.ticketNumber + "\n" +
            "Tickets: " + payload.quantity + " √ó " + eur(PRICE_EUR) + " = " + eur(payload.quantity * PRICE_EUR) + "\n" +
            "Best√§tigung an: " + payload.email,
            "success"
          );
        })
        .catch(err => {
          console.error(err);
          showMsg("‚ùå Fehler beim Abschluss / Mailversand: " + (err?.message || err), "error");
        });
      },

      onError: (err) => {
        console.error(err);
        showMsg("‚ùå PayPal-Fehler. Bitte erneut versuchen.", "error");
      }
    }).render("#paypal-button-container");
  </script>
</body>
</html>
