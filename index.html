<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Happiness e.V. – Tickets</title>
  <style>
    :root { --bg:#0b1020; --card:#121a33; --text:#e9eefc; --muted:#9fb3ff; --accent:#ffd700; }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap { min-height:100%; display:grid; place-items:center; padding:24px; }
    .card { width:100%; max-width:520px; background:var(--card); border-radius:18px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 6px; font-size:22px; }
    .sub { color:var(--muted); margin:0 0 18px; font-size:14px; }
    .grid { display:grid; gap:14px; }
    label { font-size:13px; color:var(--muted); display:block; margin-bottom:6px; }
    input,select { width:100%; padding:12px 14px; border:1px solid #2a3461; border-radius:12px; background:#0e1530; color:var(--text); outline:none; }
    input:focus { border-color:#3e57c2; }
    .row { display:grid; gap:12px; grid-template-columns:1fr 1fr; }
    .price { margin-top:4px; font-size:14px; color:var(--muted); }
    .msg { display:none; margin-top:12px; padding:10px 12px; border-radius:10px; font-size:14px; white-space:pre-line; }
    .msg.info { background:#143054; }
    .msg.success { background:#0f4d2f; }
    .msg.error { background:#5a1c1c; }
    .center { display:grid; place-items:center; }
    #paypal-button-container { margin-top:10px; }
  </style>

  <!-- PayPal SDK (Mode muss zur .env passen) -->
  <!-- Für LIVE:   https://www.paypal.com/sdk/js -->
  <!-- Für SANDBOX: https://www.sandbox.paypal.com/sdk/js -->
  <script
  src="https://www.paypal.com/sdk/js?client-id=AXhWhmESFDnMHbhG_Vktz5V4ko3lXnzMjoUDDYJy8VWHm5ktfQMEJ47cHUKLr4Z1eBnCPeWle48gNZLl&currency=EUR&intent=capture">
</script>

</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Tickets kaufen</h1>
      <p class="sub">Bezahlen nur mit PayPal. E-Ticket kommt per E-Mail.</p>

      <div class="grid">
        <div class="row">
          <div>
            <label for="vorname">Vorname</label>
            <input id="vorname" autocomplete="given-name" />
          </div>
          <div>
            <label for="nachname">Nachname</label>
            <input id="nachname" autocomplete="family-name" />
          </div>
        </div>

        <div>
          <label for="geburtsdatum">Geburtsdatum</label>
          <input id="geburtsdatum" type="date" />
        </div>

        <div>
          <label for="email">E-Mail</label>
          <input id="email" type="email" autocomplete="email" />
        </div>

        <div class="row">
          <div>
            <label for="qty">Anzahl</label>
            <input id="qty" type="number" min="1" max="20" value="1" />
          </div>
          <div class="center">
            <div class="price">
              Preis: <span id="price-each">20,00 €</span><br />
              Summe: <strong id="price-total">20,00 €</strong>
            </div>
          </div>
        </div>

        <div id="paypal-button-container"></div>
        <div id="msg" class="msg"></div>
      </div>
    </div>
  </div>

  <script>
    // ------- Config & Helpers -------
    const PRICE_EUR = 20.00;
    const MAX_QTY   = 20;
    const $  = (id) => document.getElementById(id);
    const eur = (x) => Number(x).toLocaleString("de-DE",{ style:"currency", currency:"EUR" });
    const validEmail = (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((v||"").trim());
    const clampQty = (v) => {
      let n = parseInt(v,10);
      if (Number.isNaN(n)) n = 1;
      return Math.max(1, Math.min(MAX_QTY, n));
    };
    function showMsg(text, type="info") {
      const box = $("msg");
      box.className = "msg " + type;
      box.textContent = text;
      box.style.display = "block";
    }
    function formValid() {
      const vorname = $("vorname").value.trim();
      const nachname = $("nachname").value.trim();
      const geburtsdatum = $("geburtsdatum").value.trim();
      const email = $("email").value.trim();
      const qty = clampQty($("qty").value);
      return !!(vorname && nachname && geburtsdatum && validEmail(email) && qty >= 1);
    }
    function formPayload(quantityOnly=false) {
      const payload = { quantity: clampQty($("qty").value) };
      if (!quantityOnly) {
        Object.assign(payload, {
          vorname:  $("vorname").value.trim(),
          nachname: $("nachname").value.trim(),
          alter:    $("geburtsdatum").value.trim(), // server erwartet 'alter' als string
          email:    $("email").value.trim()
        });
      }
      return payload;
    }
    // Summe live updaten
    const updateTotal = () => { $("price-total").textContent = eur(clampQty($("qty").value) * PRICE_EUR); };
    $("price-each").textContent = eur(PRICE_EUR);
    $("qty").addEventListener("input", updateTotal); updateTotal();

    // ------- PayPal Buttons (Server Flow) -------
    paypal.Buttons({
      style: { layout:"vertical", color:"gold", shape:"rect", label:"paypal" },
      onClick: (data, actions) => {
        if (!formValid()) {
          alert("Bitte alle Felder korrekt ausfüllen (Vorname, Nachname, Geburtsdatum, E-Mail, Anzahl).");
          return actions.reject();
        }
        showMsg("⏳ Bestellung wird erstellt ...", "info");
        return actions.resolve();
      },
      createOrder: () => {
        return fetch("/create-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formPayload(true))
        })
        .then(async (res) => {
          const json = await res.json().catch(()=>({}));
          if (!res.ok || !json.id) { showMsg("❌ Bestellung konnte nicht erstellt werden.", "error"); throw new Error(json.error||json.message||"create-order failed"); }
          return json.id;
        });
      },
      onApprove: (data) => {
        const payload = { orderID: data.orderID, ...formPayload(false) };
        return fetch("/capture-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(async (res) => {
          const result = await res.json().catch(()=>({}));
          if (!res.ok || !result.ticketNumber) { showMsg("❌ Fehler beim Abschluss / Mailversand.", "error"); throw new Error(result.error||result.message||"capture-order failed"); }
          showMsg(
            "✅ Zahlung erfolgreich!\n\n" +
            "Ticketnummer: " + result.ticketNumber + "\n" +
            "Tickets: " + payload.quantity + " × " + eur(PRICE_EUR) + " = " + eur(payload.quantity * PRICE_EUR) + "\n" +
            "Bestätigung an: " + payload.email,
            "success"
          );
        })
        .catch((err)=>{ console.error(err); throw err; });
      },
      onError: (err) => {
        console.error("PayPal SDK error:", err);
        showMsg("❌ PayPal-Fehler. Bitte erneut versuchen.", "error");
      }
    }).render("#paypal-button-container");
  </script>
</body>
</html>
