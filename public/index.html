<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéüÔ∏è Tickets kaufen</title>

  <!-- PayPal JS SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=AUll6OqEge1Xet4KRY9EoMTli14QZkMTAvrTJyhAxKF2-aDXeQjTdCHKN1YHv6NAam3n2L7GKuSK8jLy&currency=EUR&components=buttons&intent=capture&disable-funding=card,bancontact,blik,eps,giropay,ideal,mybank,p24,sepa,sofort,venmo,credit"></script>

  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
           max-width: 520px; margin: 40px auto; padding: 0 20px; line-height: 1.5; }
    h1 { margin-bottom: 14px; }
    label { display:block; font-size:14px; margin-top:10px; }
    input { width:100%; padding:10px; margin-top:4px; border:1px solid #ccc; border-radius:8px; box-sizing:border-box; }
    #total { font-weight:700; margin-top:10px; }
    #paypal-button-container { margin-top:18px; }
    #msg { margin-top:14px; padding:12px; border-radius:8px; display:none; }
    #msg.success { background:rgba(0,128,0,.1); color:#064; }
    #msg.error   { background:rgba(255,0,0,.1); color:#600; }
    #msg.info    { background:rgba(0,0,255,.08); color:#004; }
    .muted { color:#666; font-size:13px; }
  </style>
</head>
<body>
  <h1>üéüÔ∏è Tickets kaufen</h1>

  <form id="ticketForm" novalidate>
    <label for="vorname">Vorname</label>
    <input type="text" id="vorname" required />

    <label for="nachname">Nachname</label>
    <input type="text" id="nachname" required />

    <label for="geburtsdatum">Geburtsdatum</label>
    <input type="date" id="geburtsdatum" required />

    <label for="email">E-Mail f√ºr Ticketversand</label>
    <input type="email" id="email" inputmode="email" autocomplete="email" required />

    <label for="qty">Anzahl Tickets</label>
    <input type="number" id="qty" min="1" max="20" value="1" required />
  </form>

  <div id="total">Gesamt: 20,00 ‚Ç¨</div>
  <div id="paypal-button-container"></div>
  <div id="msg" role="status" aria-live="polite"></div>

  <p class="muted">
    Hinweis: Nur PayPal ist aktiviert. Die eingegebene E-Mail dient ausschlie√ülich dem Ticketversand und muss
    nicht mit der PayPal-E-Mail √ºbereinstimmen.
  </p>

  <script>
    const PRICE_EUR = 20.00;
    const MAX_QTY   = 20;
    const $ = id => document.getElementById(id);

    const validEmail = (v) => /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test((v||"").trim());
    const clampQty = (v) => {
      let n = parseInt(v,10);
      if (Number.isNaN(n)) n = 1;
      return Math.max(1, Math.min(MAX_QTY, n));
    };
    const formatEUR = (num) => Number(num).toLocaleString("de-DE",{style:"currency",currency:"EUR"});

    function updateTotal(){
      const q = clampQty($("qty").value);
      $("qty").value = q;
      $("total").textContent = "Gesamt: " + formatEUR(q * PRICE_EUR);
    }
    $("qty").addEventListener("input", updateTotal);
    updateTotal();

    function formValid(){
      const v = $("vorname").value.trim();
      const n = $("nachname").value.trim();
      const g = $("geburtsdatum").value.trim(); // <-- neues Feld
      const e = $("email").value.trim();
      const q = clampQty($("qty").value);
      return v && n && g && validEmail(e) && q >= 1;
    }

    function showMsg(text, type="info"){
      const box = $("msg");
      box.className = type;
      box.textContent = text;
      box.style.display = "block";
    }

    paypal.Buttons({
      fundingSource: paypal.FUNDING.PAYPAL,
      style: { layout:"vertical", color:"gold", shape:"rect", label:"paypal" },

      onInit: (data, actions) => {
        actions.disable();
        ["vorname","nachname","geburtsdatum","email","qty"].forEach(id => {
          $(id).addEventListener("input", () => formValid() ? actions.enable() : actions.disable());
        });
      },

      onClick: (data, actions) => {
        if (!formValid()) {
          showMsg("Bitte alle Felder korrekt ausf√ºllen.", "error");
          return actions.reject();
        }
        showMsg("‚è≥ Bitte warten, Bestellung wird erstellt...", "info");
        return actions.resolve();
      },

      createOrder: (data, actions) => {
        const qty   = clampQty($("qty").value);
        const total = (qty * PRICE_EUR).toFixed(2);

        return actions.order.create({
          intent: "CAPTURE",
          purchase_units: [{
            description: `Happiness e.V. ‚Äì Tickets (${qty} √ó ${PRICE_EUR.toFixed(2)} ‚Ç¨)`,
            amount: {
              currency_code: "EUR",
              value: total,
              breakdown: { item_total: { currency_code: "EUR", value: total } }
            },
            items: [{
              name: "Happiness e.V. Ticket",
              quantity: String(qty),
              unit_amount: { currency_code: "EUR", value: PRICE_EUR.toFixed(2) }
            }]
          }]
        });
      },

      onApprove: async (data, actions) => {
        try {
          const details = await actions.order.capture();
          const qty     = clampQty($("qty").value);
          const total   = (qty * PRICE_EUR).toFixed(2);

          showMsg(
            "‚úÖ Zahlung erfolgreich!\n\n" +
            "Bestell-ID: " + details.id + "\\n" +
            "Name: " + $("vorname").value.trim() + " " + $("nachname").value.trim() + "\\n" +
            "Geburtsdatum: " + $("geburtsdatum").value + "\\n" +
            "Tickets: " + qty + " √ó " + formatEUR(PRICE_EUR) + "\\n" +
            "Gesamt: " + formatEUR(total) + "\\n" +
            "Best√§tigung an: " + $("email").value.trim(),
            "success"
          );
        } catch (err) {
          console.error(err);
          showMsg("‚ùå Fehler beim Abschluss der Zahlung.", "error");
        }
      },

      onError: (err) => {
        console.error(err);
        showMsg("‚ùå PayPal-Fehler. Bitte erneut versuchen.", "error");
      }
    }).render("#paypal-button-container");
  </script>
</body>
</html>
